state machine optimization in ocaml